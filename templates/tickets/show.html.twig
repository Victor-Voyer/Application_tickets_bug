{% extends 'base.html.twig' %}

{% block title %}{{ ticket.title }} - Ticket #{{ ticket.id }}{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('styles/ticket-show.css') }}">
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('upload_img.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('.add-comment-form form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    // Forcer la synchronisation de tous les CKEditor avant soumission
                    document.querySelectorAll('.ck-editor').forEach((editorElement) => {
                        const textarea = editorElement.previousElementSibling;
                        if (textarea && textarea.tagName === 'TEXTAREA') {
                            const editorInstance = textarea.ckeditorInstance;
                            if (editorInstance) {
                                textarea.value = editorInstance.getData();
                            }
                        }
                    });
                });
            }
        });
    </script>
{% endblock %}

{% block body %}
    <div class="ticket-show-container">
        {# Flash messages #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        {# Navigation #}
        <div class="ticket-navigation">
            <a href="{{ path('app_tickets_index') }}">← Back to list</a>
        </div>

        {# Ticket header #}
        <div class="ticket-header">
            <h1>{{ ticket.title }}</h1>
            <div class="ticket-meta">
                <span class="ticket-id">Ticket #{{ ticket.id }}</span>
                <span class="ticket-status">Status: {{ ticket.status.status.value }}</span>
                <span class="ticket-type">Type: {{ ticket.type.value }}</span>
                <span class="ticket-stack">Stack: {{ ticket.stack.value }}</span>
            </div>
        </div>

        {# Main information #}
        <div class="ticket-main">
            <div class="ticket-content">
                <h2>Description</h2>
                <div class="content-text">
                    {{ ticket.content|raw }}
                </div>
            </div>

            <div class="ticket-info">
                <h3>Information</h3>
                <dl>
                    <dt>Created on:</dt>
                    <dd>{{ ticket.createdAt|date('d/m/Y à H:i') }}</dd>
                    
                    <dt>Created by:</dt>
                    <dd>
                        {{ ticket.userId.firstName }} {{ ticket.userId.lastName }} 
                        ({{ ticket.userId.nickname }})
                    </dd>
                    
                    <dt>Email:</dt>
                    <dd>{{ ticket.userId.email }}</dd>
                </dl>
            </div>
        </div>

        {# Attached images #}
        {% if ticket.images|length > 0 %}
            <div class="ticket-images">
                <h2>Attached images ({{ ticket.images|length }})</h2>
                <div class="images-grid">
                    {% for image in ticket.images %}
                        <div class="image-item">
                            <img src="{{ asset(image.url) }}" alt="Ticket image" class="clickable-image" title="Click to enlarge">
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {# Comments section #}
        <div class="ticket-comments">
            <h2>Comments ({{ ticket.comments|length }})</h2>
            
            {% if ticket.comments|length > 0 %}
                <div class="comments-list">
                    {% for comment in ticket.comments %}
                        <div class="comment-item">
                            <div class="comment-header">
                                <strong>{{ comment.userId.firstName }} {{ comment.userId.lastName }}</strong>
                                <span class="comment-date">{{ comment.createdAt|date('d/m/Y à H:i') }}</span>
                                {% if comment.updatedAt %}
                                    <span class="comment-edited">(edited on {{ comment.updatedAt|date('d/m/Y à H:i') }})</span>
                                {% endif %}
                            </div>
                            <div class="comment-content">
                                {{ comment.content|raw }}
                            </div>
                            
                            {# Comment images #}
                            {% if comment.images|length > 0 %}
                                <div class="comment-images">
                                    {% for image in comment.images %}
                                        <img src="{{ asset(image.url) }}" alt="Comment image" class="clickable-image" title="Click to enlarge" style="max-width: 200px; cursor: pointer;">
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No comments yet.</p>
            {% endif %}
            
            {# Add comment form #}
            <div class="add-comment-form">
                <h3>Add a comment</h3>
                {# attr novalidate to disable HTML5 validation, it disables the validation of fields that are "required" by default #}
                {{ form_start(commentForm, {'attr': {'novalidate': 'novalidate'}}) }}
                    {{ form_errors(commentForm) }}
                    {{ form_row(commentForm.content) }}
                    {{ form_row(commentForm.imageFiles) }}
                    <button type="submit" class="btn btn-primary">+ Add a comment</button>
                {{ form_end(commentForm) }}
            </div>
        </div>

        {# Actions #}
        <div class="ticket-actions">
            {{ include('tickets/_delete_form.html.twig') }}
            {{ include('tickets/_update_status.html.twig') }}
        </div>
    </div>

    {# Lightbox pour agrandir les images #}
    <div id="image-lightbox" class="lightbox">
        <span class="lightbox-close">&times;</span>
        <img id="lightbox-image" class="lightbox-content" src="" alt="">
    </div>
{% endblock %}
